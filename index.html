<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Triple Buzzer!</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #1a227ee9 0%, #3949ab 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .chat-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 1200px;
        height: min(90vh, 800px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
        color: #ffd700;
        padding: 20px;
        text-align: center;
        font-size: 1.8rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .header-actions {
        position: absolute;
        right: 20px;
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .header-actions a {
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        transition: transform 0.2s;
      }

      .header-actions a:hover {
        transform: translateY(-2px);
      }

      .deploy-button {
        background: rgba(255, 255, 255, 0.2);
        color: #ffd700;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        border: 1px solid rgba(255, 215, 0, 0.3);
        transition: background 0.2s, transform 0.2s;
      }

      .deploy-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .github-icon {
        width: 24px;
        height: 24px;
        fill: #ffd700;
        transition: fill 0.2s;
      }

      .github-icon:hover {
        fill: #fff;
      }

      .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .message {
        display: flex;
        margin-bottom: 15px;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.assistant {
        justify-content: flex-start;
      }

      .message-content {
        max-width: 80%;
        padding: 12px 18px;
        border-radius: 9px;
        font-size: 0.95rem;
        line-height: 1.4;
        position: relative;
      }

      .message.user .message-content {
        background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
        color: #ffd700;
        border-bottom-right-radius: 5px;
        font-weight: 600;
      }

      .message.assistant .message-content {
        background: #f1f3f5;
        color: #333;
        border-bottom-left-radius: 5px;
        position: relative;
      }

      .backend-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
        color: #ffd700;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 6px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .backend-badge.ai-sdk {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }

      .backend-badge.anthropic {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .backend-badge.gemini {
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      }

      .chat-input-container {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
      }

      .backend-selector {
        margin-bottom: 15px;
        font-size: 0.9rem;
        color: #666;
      }

      .backend-selector label {
        font-weight: 600;
        display: block;
        margin-bottom: 8px;
      }

      .backend-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .backend-option {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 5px;
        background: white;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .backend-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .model-selector {
        display: none;
        margin-top: 5px;
      }

      .backend-option.selected .model-selector {
        display: block;
      }

      .model-selector select {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ddd;
        font-size: 0.75rem;
        background: white;
      }

      .backend-option:hover {
        border-color: #1a237e;
      }

      .backend-option input[type="checkbox"] {
        margin: 0;
      }

      .backend-option.selected {
        background: #1a237e;
        color: #ffd700;
        border-color: #1a237e;
      }

      .chat-input {
        display: flex;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        padding: 12px 18px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s;
      }

      .chat-input input:focus {
        border-color: #1a237e;
      }

      .chat-input button {
        padding: 12px 24px;
        background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
        color: #ffd700;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .chat-input button#randomButton {
        padding: 12px 18px;
        font-size: 1.2rem;
        min-width: 50px;
      }

      .chat-input button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(26, 35, 126, 0.4);
      }

      .chat-input button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .typing-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        color: #666;
        font-style: italic;
        margin-bottom: 15px;
        padding-left: 20px;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dots span {
        width: 8px;
        height: 8px;
        background: #1a237e;
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.3;
        }

        30% {
          transform: translateY(-10px);
          opacity: 1;
        }
      }

      .error-message {
        background: #ff6b6b;
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
      }

      .welcome-message {
        text-align: center;
        color: #666;
        padding: 40px 20px;
        font-style: italic;
      }

      .welcome-subtitle {
        text-align: center;
        color: #888;
        padding: 0 20px 20px;
        font-size: 0.85rem;
        line-height: 1.4;
      }

      @media (min-width: 1400px) {
        .chat-container {
          max-width: 1400px;
          height: min(85vh, 900px);
        }
      }

      @media (max-width: 768px) {
        .chat-container {
          height: 100vh;
          border-radius: 0;
          margin: 0;
          max-width: 100%;
        }

        body {
          padding: 0;
        }

        .backend-options {
          flex-direction: column;
          gap: 8px;
        }

        .backend-option {
          justify-content: flex-start;
        }

        .chat-header {
          font-size: 1.4rem;
          padding: 15px;
        }

        .header-actions {
          display: none;
        }
      }

      @media (max-width: 480px) {
        .chat-header {
          font-size: 1.2rem;
          padding: 12px;
        }

        .message-content {
          max-width: 90%;
          font-size: 0.9rem;
        }

        .chat-input-container {
          padding: 15px;
        }
      }
    </style>
  </head>

  <body>
    <div class="chat-container">
      <div class="chat-header">
        <span>âœ¨ Triple Buzzer! NETLIFY AI GAME âœ¨</span>
        <div class="header-actions">
          <a href="https://app.netlify.com/start/deploy?repository=https://github.com/netlify-templates/triple-buzzer"
             target="_blank"
             rel="noopener noreferrer"
             class="deploy-button"
             title="Deploy your own copy">
            Deploy to Netlify
          </a>
          <a href="https://github.com/netlify-templates/triple-buzzer"
             target="_blank"
             rel="noopener noreferrer"
             title="View on GitHub">
            <svg class="github-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
          </a>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="welcome-message">
          Welcome to Triple Buzzer, a Netlify AI game! Give me an answer and
          I'll respond with the correct question.
        </div>

        <div class="welcome-subtitle">
          Remember when IBM Watson went on Jeopardy!? Well, this is nothing like
          that because we hold neither of those copyrights.
        </div>
      </div>

      <div class="typing-indicator" id="typingIndicator">
        <span>AI is typing</span>
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="backend-selector">
          <label>Select contestants:</label>
          <div class="backend-options">
            <div class="backend-option">
              <div class="backend-checkbox">
                <input type="checkbox" value="/openai" checked />
                <span>OpenAI</span>
              </div>
              <div class="model-selector">
                <select data-backend="openai">
                  <option value="gpt-4o-mini">Loading models...</option>
                </select>
              </div>
            </div>
            <div class="backend-option">
              <div class="backend-checkbox">
                <input type="checkbox" value="/anthropic" checked />
                <span>Anthropic</span>
              </div>
              <div class="model-selector">
                <select data-backend="anthropic">
                  <option value="claude-3-5-haiku-20241022">
                    Loading models...
                  </option>
                </select>
              </div>
            </div>
            <div class="backend-option">
              <div class="backend-checkbox">
                <input type="checkbox" value="/gemini" checked />
                <span>Gemini</span>
              </div>
              <div class="model-selector">
                <select data-backend="gemini">
                  <option value="gemini-2.5-flash">Loading models...</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="chat-input">
          <input
            type="text"
            id="messageInput"
            value="This country borders Germany, Belgium, and the North Sea"
            maxlength="500"
          />
          <button id="randomButton" title="Get random example">ðŸŽ²</button>
          <button id="sendButton">Send</button>
        </div>
      </div>
    </div>

    <script>
      const exampleQuestions = [
        "This TV character knows nothing",
        "SYSTEM_PROMPT",
        "This makes sushi more than plain rice",
        "This is the only mammal capable of true flight",
        "This animal is the only one that can't jump",
        "This 1969 event was one small step for man, one giant leap for mankind",
        "This film grossed over $1.5, and its hero was dressed in pink",
        "This programming language construct is considered harmful",
        "North, Saint, Chicago, and Psalm",
        "BrasÃ­lia",
        "The assassination of Archduke Franz Ferdinand of Austria",
        "Orange juice and vodka",
        "This TV show is set in the fictional town of Springfield",
        "Something I don't like",
        "This country was the first to legalize same-sex marriage",
        "This person was the first woman to win an Oscar for Best Director",
        "This bird is known for its ability to fly backwards",
        "This company's designs inspired many Apple products",
        "Developers, developers, developers",
        "He had a day off and borrowed a vintage Ferrari Spyder",
        "A giant sandworm",
        "The first snack known to humankind",
        "The most vulnerable operating system",
        "These two US presidents were father and son",
        "...is my system prompt",
        "This animal can sleep for three years straight",
        "This country invented beer",
        "I'm a musician some believe to be Banksy",
        "I'm the GOAT",
        "This national park's name is also an album name",
      ];

      const chatMessages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");
      const typingIndicator = document.getElementById("typingIndicator");
      const backendOptions = document.querySelectorAll(
        '.backend-option input[type="checkbox"]'
      );

      let isLoading = false;

      // Fetch available models from Netlify Edge Function
      async function fetchAvailableModels() {
        try {
          const response = await fetch("/api/ai-models");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const modelsByProvider = await response.json();

          // Update model dropdowns for each provider
          Object.entries(modelsByProvider).forEach(([backend, models]) => {
            const selectElement = document.querySelector(
              `select[data-backend="${backend}"]`
            );

            if (selectElement && models && models.length > 0) {
              // Clear existing options
              selectElement.innerHTML = "";

              let selectedIndex = 0;
              models.forEach((model, index) => {
                if (
                  [
                    "gpt-5-mini",
                    "claude-3-5-haiku-latest",
                    "gemini-2.5-flash",
                  ].includes(model)
                )
                  selectedIndex = index;
              });

              // Add new options from API
              models.forEach((model, index) => {
                const option = document.createElement("option");
                option.value = model;
                option.textContent = model;

                if (index === selectedIndex) {
                  option.textContent += " (default)";
                  option.selected = true;
                }

                selectElement.appendChild(option);
              });
            } else if (selectElement && models.length === 0) {
              // No models available
              selectElement.innerHTML =
                '<option value="">No models available</option>';
            }
          });
        } catch (error) {
          console.error("Failed to fetch models:", error);
          // Clear dropdowns on error
          ["openai", "anthropic", "gemini"].forEach((backend) => {
            const selectElement = document.querySelector(
              `select[data-backend="${backend}"]`
            );
            if (selectElement) {
              selectElement.innerHTML =
                '<option value="">Failed to load models</option>';
            }
          });
        }
      }

      // Fetch models on page load
      fetchAvailableModels();

      function addMessage(
        content,
        type,
        backend = null,
        model = null,
        responseTime = null
      ) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";
        messageContent.textContent = content;

        // Add backend badge for assistant messages
        if (type === "assistant" && backend) {
          const badge = document.createElement("div");
          badge.className = `backend-badge ${backend}`;

          let badgeText = "OpenAI";
          if (backend === "anthropic") {
            badgeText = "Claude";
          } else if (backend === "gemini") {
            badgeText = "Gemini";
          }

          badge.textContent = badgeText;
          badge.title = `Backend: ${backend}, Model: ${model || "unknown"}`;
          messageContent.appendChild(badge);

          // Add timing indicator if provided
          if (responseTime !== null) {
            const timing = document.createElement("div");
            timing.className = "timing-indicator";
            timing.textContent = `${responseTime}ms`;
            timing.style.cssText = `
            position: absolute;
            bottom: -8px;
            right: -8px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 500;
          `;
            messageContent.appendChild(timing);
          }
        }

        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);

        // Remove welcome messages if they exist
        const welcomeMessage = chatMessages.querySelector(".welcome-message");
        const welcomeSubtitle = chatMessages.querySelector(".welcome-subtitle");
        if (welcomeMessage) {
          welcomeMessage.remove();
        }
        if (welcomeSubtitle) {
          welcomeSubtitle.remove();
        }

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.textContent = message;
        chatMessages.appendChild(errorDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function setLoading(loading) {
        isLoading = loading;
        sendButton.disabled = loading;
        messageInput.disabled = loading;

        if (loading) {
          typingIndicator.style.display = "flex";
          sendButton.textContent = "Sending...";
        } else {
          typingIndicator.style.display = "none";
          sendButton.textContent = "Send";
        }

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isLoading) return;

        const selectedEndpoints = Array.from(backendOptions)
          .filter((checkbox) => checkbox.checked)
          .map((checkbox) => checkbox.value);

        if (selectedEndpoints.length === 0) {
          showError("Please select at least one backend");
          return;
        }

        // Add user message to chat
        addMessage(message, "user");
        setLoading(true);

        try {
          // Send requests to all selected models in parallel
          let pendingRequests = selectedEndpoints.length;

          selectedEndpoints.forEach(async (endpoint) => {
            const startTime = performance.now();

            // Get selected model for this backend
            const backendName = endpoint.replace("/", "");
            const modelSelect = document.querySelector(
              `select[data-backend="${backendName}"]`
            );
            const selectedModel = modelSelect ? modelSelect.value : null;

            try {
              const response = await fetch("/api" + endpoint, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ message, model: selectedModel }),
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();
              console.log(`Response from ${endpoint}: ${JSON.stringify(data)}`);

              if (data.error) {
                throw new Error(data.error);
              }

              // Add response immediately as it comes in
              const responseTime = Math.round(performance.now() - startTime);
              addMessage(
                data.answer,
                "assistant",
                endpoint.replace("/", ""),
                null,
                responseTime
              );
            } catch (error) {
              showError(`${endpoint.replace("/", "")}: ${error.message}`);
            } finally {
              pendingRequests--;
              if (pendingRequests === 0) {
                setLoading(false);
                messageInput.focus();
              }
            }
          });
        } catch (error) {
          console.error("Error sending message:", error);
          showError(`Error: ${error.message}`);
          setLoading(false);
          messageInput.focus();
        }
      }

      // Event listeners
      sendButton.addEventListener("click", sendMessage);

      const randomButton = document.getElementById("randomButton");
      randomButton.addEventListener("click", () => {
        const randomIndex = Math.floor(Math.random() * exampleQuestions.length);
        messageInput.value = exampleQuestions[randomIndex];
        messageInput.focus();
      });

      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Update checkbox styling when checked
      backendOptions.forEach((checkbox) => {
        checkbox.addEventListener("change", function () {
          const option = this.closest(".backend-option");
          if (this.checked) {
            option.classList.add("selected");
          } else {
            option.classList.remove("selected");
          }
        });

        // Initialize styling
        if (checkbox.checked) {
          checkbox.closest(".backend-option").classList.add("selected");
        }

        // Make the whole div clickable (but not the model dropdown)
        const option = checkbox.closest(".backend-option");
        option.addEventListener("click", function (e) {
          // Don't trigger if clicking on the model dropdown
          if (
            e.target.tagName === "SELECT" ||
            e.target.closest(".model-selector select")
          ) {
            return;
          }

          // Toggle the checkbox
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event("change"));
        });
      });

      // Focus input on load
      messageInput.focus();
    </script>
  </body>
</html>
